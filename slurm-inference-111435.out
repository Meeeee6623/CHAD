[2025-04-21 06:01:40,275] [INFO] [real_accelerator.py:239:get_accelerator] Setting ds_accelerator to cuda (auto detect)
Warning: The cache directory for DeepSpeed Triton autotune, /home/pl217/.triton/autotune, appears to be on an NFS system. While this is generally acceptable, if you experience slowdowns or hanging when DeepSpeed exits, it is recommended to set the TRITON_CACHE_DIR environment variable to a non-NFS path.
Using device: cuda
Using model dtype: torch.bfloat16
Loading tokenizer...
No PAD token found. Adding and using EOS token as PAD.
Tokenizer loaded. Vocab size: 128000
BOS: '<|begin_of_text|>' (ID: 128000), EOS: '<|eot_id|>' (ID: 128009), PAD: '<|eot_id|>' (ID: 128009)
Creating base model structure...
Initialized Gated Update mechanism.
Gradient checkpointing enabled for Transformer blocks.
Base model structure created.
Loading pretrained weights for meta-llama/Llama-3.2-3B-Instruct into base structure...
Initializing HopfieldLlama3Model (Scratch Base) with dtype: torch.bfloat16
Initialized Gated Update mechanism.
Gradient checkpointing enabled for Transformer blocks.
Loading pretrained weights for meta-llama/Llama-3.2-3B-Instruct...
Assuming 2 weight shards for meta-llama/Llama-3.2-3B-Instruct.
Loading weights from model-00001-of-00002.safetensors to CPU...
Loading weights from model-00002-of-00002.safetensors to CPU...
Base model weights loaded into HAT structure.
Applying weight tying for output head.
Explicitly initializing Hopfield memory...
Initializing Hopfield memory (embedding_sampling)...
Initialized stored patterns by sampling embeddings (sliced to head_dim).
Model creation and weight loading complete.
Pretrained weights loaded into base model.
Loading LoRA adapter from checkpoint: /home/pl217/continualearning/narrativeqa_hat_finetune_3.2_3B_run1/checkpoint-10
LoRA adapter loaded.
Model moved to device and set to eval mode.
Generation config attached to model.
Loading test dataset (summaries)...
Processed summary data cache not found for split 'test': ./data_cache/processed_narrativeqa_summary/processed_summary_test_f57db746d7d48033.pt. Processing...
Processing test split using summaries...

--- RAW ANSWERS STRUCTURE ---
Type: <class 'list'>, Length: 2
First answer object: {'text': 'He is a high school student in Phoenix.', 'tokens': ['He', 'is', 'a', 'high', 'school', 'student', 'in', 'Phoenix', '.']}
Keys in first answer: ['text', 'tokens']
Text field: He is a high school student in Phoenix.
Tokens field: ['He', 'is', 'a', 'high', 'school', 'student', 'in', 'Phoenix', '.']
---------------------------

First answer text extracted: 'He is a high school student in Phoenix.'
DEBUG - First answer being used: 'He is a high school student in Phoenix.'
Complete answer length: 39

--- LABEL DEBUG --- First Example ---
Input Tokens Len: 678
Answer Tokens Len: 10
Target Tokens Len: 688
Labels Tensor Len: 678
Context End Idx: 638
Number of non -100 labels BEFORE context mask: 40
Number of non -100 labels AFTER context mask (should be >0): 40
Decoded Answer from Labels: 'system

Cutting Knowledge Date: December 2023
Today Date: 21 Apr 2025

user

Who is Mark Hunter?assistant

He'
Original Answer Text:       'He is a high school student in Phoenix.'
----------------------------------


--- First Processed Example (Summary Based) --- 
Document ID: 0025577043f5090cd603c6aea60f26e236195594

Summary Context Tokens (638):
 Mark Hunter (Slater), a high school student in a sleepy suburb of Phoenix, Arizona, starts an FM pirate radio station that broadcasts from the basement of his parents' house. Mark is a loner, an outsider, whose only outlet for his teenage angst and aggression is his unauthorized radio station. His pirate station's theme song is "Everybody Knows" by Leonard Cohen and there are glimpses of cassettes by such alternative musicians as The Jesus and Mary Chain, Camper Van Beethoven, Primal Scream, Soundgarden, Ice-T, Bad Brains, Concrete Blonde, Henry Rollins, and The Pixies. By day, Mark is seen as a loner, hardly talking to anyone around him; by night, he expresses his outsider views about what is wrong with American society. When he speaks his mind about what is going on at his school and in the community, more and more of his fellow students tune in to hear his show.
Nobody knows the true identity of "Hard Harry" or "Happy Harry Hard-on," as Mark refers to himself, until Nora Diniro (Mathis), a fellow student, tracks him down and confronts him the day after a student named Malcolm commits suicide after Harry attempts to reason with him. The radio show becomes increasingly popular and influential after Harry confronts the suicide head-on, exhorting his listeners to do something about their problems instead of surrendering to them through suicideâat the crescendo of his yelled speech, an overachieving student named Paige Woodward (who has been a constant listener) jams her various medals and accolades into a microwave and turns it on. She then sits, watching the awards cook until the microwave explodes, injuring her. While this is happening, other students act out in cathartic release.
Eventually, the radio show causes so much trouble in the community that the FCC is called in to investigate. During the fracas, it is revealed that the school's principal (Annie Ross) has been expelling "problem students," namely, students with below-average standardized test scores, in an effort to boost the district's test scores while still keeping their names on the rolls (a criminal offense) in order to retain government funding.
Realizing he has started something huge, Mark decides it is up to him to end it. He dismantles his radio station and attaches it to his mother's old jeep, creating a mobile transmitter so his position can't be triangulated. Pursued by the police and the FCC, Nora drives the jeep around while Mark broadcasts. The harmonizer he uses to disguise his voice breaks, and with no time left to fix it, Mark decides to broadcast his final message as himself. They finally drive up to the crowd of protesting students, and Mark tells them that the world belongs to them and that they should make their own future. The police step in and arrest Mark and Nora. As they are taken away, Mark reminds the students to "talk hard." As the film ends, the voices of other students (and even one of the teachers) speak as intros for their own independent stations, which can be heard broadcasting across the country.

Original Question:
Who is Mark Hunter?

Answer Tokens (9):
He is a high school student in Phoenix.

Context End Index: 638
-----------------------------

Finished processing test (summaries). Created 10557 instances. Skipped 0.
Saving processed summary data for split 'test' to cache: ./data_cache/processed_narrativeqa_summary/processed_summary_test_f57db746d7d48033.pt
Test dataset loaded with 10557 examples.
Running MEMORY-ONLY inference test on first 10 examples...
NOTICE: Stage 2 will ONLY see the question without context to test memory retention

--- INFERENCE LABEL DEBUG (Example 1) ---
Raw labels shape for this item: torch.Size([681])
Valid answer label token IDs: [128006, 9125, 128007, 271, 38766, 1303, 33025, 2696, 25, 6790, 220, 2366, 18, 198, 15724, 2696, 25, 220, 1691, 5186, 220, 2366, 20, 271, 128009, 128006, 882, 128007, 271, 15546, 374, 4488, 24008, 30, 128009, 128006, 78191, 128007, 271, 1548]
Decoded Answer directly from Inference Labels: 'system

Cutting Knowledge Date: December 2023
Today Date: 21 Apr 2025

user

Who is Mark Hunter?assistant

He'
------------------------------------------

Hopfield memory state cleared.
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0
Initializing RoPE/Mask buffers (len=4096) on device cuda:0

Example 1: Testing MEMORY ONLY with question (no context)
Inference job finished.
